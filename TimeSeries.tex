\documentclass[11pt,a4paper]{ivoa}
\input tthdefs

\usepackage{todonotes}
\usepackage{enumitem}
\usepackage{pdflscape}
\usepackage{xcolor,colortbl}
\usepackage[most]{tcolorbox}
 
\usepackage{listings}
\lstloadlanguages{XML,sh}
\lstset{flexiblecolumns=true,tagstyle=\ttfamily,
showstringspaces=False}

\usepackage{multirow}

\definecolor{LightBlue}{rgb}{0.0,0.318,0.612}
\definecolor{LighterBlue}{rgb}{0.39,0.7,1}

% Added this comand for my text to be added in blue and boldface

\newcommand\ada[1]{\textcolor{blue}{\textbf{#1}}}

%\newcommand\elem[1]{\textcolor{LightBlue}{{\tt#1}}}
\newcommand\celcol[1]{\cellcolor{LighterBlue}{\textbf{#1}}}
%\def\attr#1{{\tt{\fg{DarkRed}#1}}}

\let\A=\href
\def\Aref#1{section~\ref{#1}}
\def\Arefs#1{section~\ref{#1}}
\def\Arefx#1{appendix~\ref{#1}}
\def\Tref#1{Table~\ref{#1}}
\def\Fref#1{Figure~\ref{#1}}
\let\fg=\color
%\topmargin=-1cm
%\raggedbottom
%\oddsidemargin=-0.8cm
%\evensidemargin=-0.8cm
%\textwidth=17.5cm
%\textheight=23.5cm
\parindent=0pt
\arrayrulewidth=0.75pt\renewcommand{\arraystretch}{1.2}
\definecolor{DarkRed}{rgb}{0.5,0,0}
\definecolor{DarkBlue}{rgb}{0,0,0.5}
\definecolor{DarkPurple}{rgb}{0.3,0.1,0.5}
\definecolor{DarkGoldenrod}{rgb}{0.72,0.5,0.05}
\def\slash {{\fg{blue}/}}
\def\attr#1{{\tt{\fg{DarkRed}#1}}}
\def\requiredattr#1{{\tt\bf{\fg{DarkBlue}#1}}}
\def\elem#1{{\tt{\fg{DarkRed}#1}}}
\def\attrval#1#2{{\tt{\fg{DarkRed}#1}="{\fg{DarkPurple}#2}"}}
\def\elemdef#1#2{{\tt\fg{blue}<}{\tt{\fg{DarkRed}#1}#2}{\tt\fg{blue}>}}
\def\literalvalue#1{{\tt"}{{\fg{DarkPurple}#1}}{\tt"}}
\def\order{$\oplus$ }
\def\unorder{{\large $\circ$ }}
\def\deprecated {$\dagger$ }
\def\choice{{$\mapsto$ }}
\newenvironment{plain}{\begin{quote}}{\end{quote}}


\title{Time Series Annotation in VOTable}
\ivoagroup{Data Model}
\author[http://www.ivoa.net/twiki/bin/view/IVOA/AdaNebot]{Ada Nebot}
\author[http://www.ivoa.net/twiki/bin/view/IVOA/FrancoisBonnarel]{Francois Bonnarel}
\author[http://www.ivoa.net/twiki/bin/view/IVOA/MireilleLouys]{Mireille Louys}
\author[http://www.ivoa.net/twiki/bin/view/IVOA/LaurantMichel]{Laurant Michel}
\author[http://www.ivoa.net/twiki/bin/view/IVOA/DaveMorris]{Dave Morris}
\author[http://www.ivoa.net/twiki/bin/view/IVOA/JesusSalgado]{Jesus Salgado}
\editor{Ada Nebot}

\begin{document}
\begin{abstract}
  This document describes a proposal to annotate in a VOTable time series data. It is limitted to the most common type of time series, i.e. tabular data containing a parameter measured as a function of time. The annotation reuses elements of exisiting Data Models when possible and defines a set of new elements. This document can be taken as a test case of the more general purpose model CADM. 
\end{abstract}

\section*{Acknowledgments}
Should we acknowledge previous work from M. Graham and others

%ASTERICS

ESCAPE

\section*{Conformance-related definitions}

The words ``MUST'', ``SHALL'', ``SHOULD'', ``MAY'', ``RECOMMENDED'', and
``OPTIONAL'' (in upper or lower case) used in this document are to be
interpreted as described in IETF standard RFC2119 \citep{std:RFC2119}.

The \emph{Virtual Observatory (VO)} is a
general term for a collection of federated resources that can be used
to conduct astronomical research, education, and outreach.
The \href{http://www.ivoa.net}{International
Virtual Observatory Alliance (IVOA)} is a global
collaboration of separately funded projects to develop standards and
infrastructure that enable VO applications.


\section{Introduction}
This document describes how data providers can publish time series of tabular data to the Virtual Observatory. This document does not describe how data providers store or manipulate the data, it only concerns how the data are exposed to the world using well-defined metadata. This document assumes that the data provider already destributes time series as a single table, this table can contain several columns. This document does not limit the number of columns the time series can contain to those explecitely mentioned here. It only suggest metadata to the most common columns in time series.  

% Notes don't need the architecture diagram

\section{The Time Series Structure}
\label{elem:TIMESERIES}
This document proposes the minimum metadata in VOTables to describe time series. We assume that the tabular data can contain multiple rows for each astronomical source and for mixed types of time series (e.~g. different filters, positions, radial velocities) and sometimes even include different types of data (e.~g. spectra, or images). 

We propose using some elements previously defined, such as \elem{TIMESYS} and \elem{COOSYS} (when applicable) in VOTable1.4 \cite{VOTable1.4} and define a set of new elements as well as how to structure these elements. The aim is to be able to combine multiple time series when they have common elements as described in this document. We include in this document the definition of \elem{TIMESYS} and \elem{COOSYS} as described in VOTable and based on those, we define the new elements \elem{FILTERSYS} and \elem{VELSYS} following the same type of structure. If these elements were to be added or modified in future versions of VOTable it should be straight forward to update this document. 

\subsection{\elem{TIMESYS} Element}
\elem{TIMESYS} contains information on the time scale, reference position and offset regarding the time of the observation \cite{VOTable1.4, TIMESYS}. A service providing time series \textbf{MUST} provide this element. To reference the time system defined by a \elem{TIMESYS} element, \elem{FIELD}s (and possibly \elem{PARAM}s) \textbf{MUST} reference the \elem{TIMESYS} using the VOTable \attr{ref} attribute. A \elem{TIMESYS} element referenced via a \attr{ref} attribute \textbf{SHOULD} appear before the element that references it.  The elements of TIMESYS, reported in the specification of VOTable1.4 \ref{VOTable1.4}, are the following:
\begin{description}
   \item[\attr{ID}] This attribute is used to reference \elem{TIMESYS} elements from the elements using the time system.
   \item[\attr{timeorigin}] This is the time origin of the time coordinate, given as a Julian Date for the the time scale and reference point
defined.  It is usually given as a floating point literal; for convenience, the magic strings \verb|MJD-origin| (standing
for 2400000.5) and \verb|JD-origin| (standing for 0) are also allowed. The timeorigin attribute \textbf{MUST} be given unless the time's representation contains a year of a calendar era, in which case it \textbf{MUST NOT} be present. In VOTables, these representations currently are Gregorian calendar years with \elem{xtype}{timestamp}, or years in the Julian or Besselian calendar when a column has \verb|yr|, \verb|a| or \verb|Ba| as its unit and no time origin is given. 
   \item[\attr{timescale}] This is the time scale used. Values \textbf{SHOULD} be taken from the IVOA \emph{timescale} vocabulary (\url{http://www.ivoa.net/rdf/timescale}). This attribute is mandatory.
   \item[\attr{refposition}] The reference position again is a simple string, the values of which SHOULD be taken from the IVOA \emph{refposition} vocabulary (\url{http://www.ivoa.net/rdf/refposition}). This attribute is mandatory.
\end{description}

\noindent
\begingroup\footnotesize
\begin{tcolorbox}
\begin{verbatim}
<TIMESYS ID="time_frame" refposition="BARYCENTER" timeorigin="2455197.5"
         timescale="TCB"/>
\end{verbatim}
\end{tcolorbox}
\endgroup

\subsection{\elem{COOSYS} Element}
\elem{COOSYS} element defines a celestial coordinate system, to which the components of a position on the celestial sphere refer.
To reference the time system defined by a \elem{COOSYS} element, \elem{FIELD}s (and possibly \elem{PARAM}s) \textbf{MUST} reference the \elem{COOSYS} using the VOTable \attr{ref} attribute. A \elem{COOSYS} element referenced via a \attr{ref} attribute \textbf{SHOULD} appear before the element that references it. The elements of \elem{COOSYS}, reported in the specification of VOTable1.4 \ref{VOTable1.4}, are the following:
\begin{description}
     \item[\attr{ID}] This attribute is used to reference the \elem{COOSYS} elements from the elements using the coordinate system. This attribute is mandatory.
     \item[\attr{system}] This attribute specifies the coordinate system among \verb|"BCRS"|, \verb|"ICRS"|, \verb|"eq_FK5"|, \verb|"eq_FK4"|, \verb|"ecl_FK4"|, \verb|"ecl_FK5"|, \verb|"galactic"|, \verb|"supergalactic"|. 
     \item[\attr{equinox}] This attribute fixes the equatorial or ecliptic systems (e.g., \verb|"J2000"| as the default for \verb|"eq_FK5"| or \verb|"B1950"| as the default for \verb|"eq_FK4"|).
     \item[\attr{epoch}] This attribute specifies the epoch of the positions when necessary.\todo{epoch should be able to vary...}
\end{description}

\noindent
\begingroup\footnotesize
\begin{tcolorbox}
\begin{verbatim}
<COOSYS ID="system" epoch="J2015.5" system="ICRS"/>
\end{verbatim}
\end{tcolorbox}
\endgroup

\subsection{\elem{FILTERSYS} Element}
\elem{FILTERSYS} contains information on the photometric system of the observations. This element is partially asociated to the intermediate class PhotCal of the Photometry Data Model \cite{PhotometryDM}. A service providing time series of the type light-curve (e.~g. magnitudes, fluxes) \textbf{MUST} provide this element. To reference the photometric system defined by a \elem{FILTERSYS} element, \elem{FIELD}s (and possibly \elem{PARAM}s) \textbf{MUST} reference the \elem{FILTERSYS} using the VOTable \attr{ref} attribute. A \elem{FILTERSYS} element referenced via a \attr{ref} attribute \textbf{SHOULD} appear before the element that references it. 


Each \elem{FILTERSYS} is defined as a \elem{GROUP} with the following mandatory terms:
\begin{description}
     \item[\attrval{name}{FILTERSYS}] The name of the \elem{GROUP} \textbf{MUST} be set to \verb|FILTERSYS|. We realize that although this proposed usage of the \attr{name} is not common, it is not forbidden by VOTable \cite[][see Section 3.2], and in this context it will help clients interpret the contents of the \elem{GROUP}. 
     \item[\attr{ID}] This attribute is used to reference the \elem{FILTERSYS} \elem{GROUP} from the elements using the photometric system. This attribute is mandatory.
     \item[\attr{DESCRIPTION}] This attribute is used to describe the \elem{FILTERSYS} \elem{GROUP}. This attribute is optional, but recommended.
     \item[\attrval{utype}{timeseries:PhotometryPoint}]
\end{description}

The attributes of this \elem{GROUP} are defined as \elem{PARAM}s containing the following information: 
\begin{description}
\item[\elem{uniqueIdentifier}] This is the \elem{PARAM} element to uniquely identify the zero point assigned to a filter and to a specific photometric system. This element MUST have the following attributes:
\begin{description}
    \item[\attrval{name}{uniqueIdentifier}]
    \item[\attrval{ucd}{meta.id;instr.filter}]
    \item[\attrval{utype}{photDM:PhotometryFilter.identifier}]
    \item[\attrval{datatype}{char}]
    \item[\attrval{value}{value}] Value SHOULD follow the syntax: Facility/Subcategory/Band (e.~g. \attrval{value}{GAIA/GAIA.G/G}, \attrval{value}{Palomar/ZTF.r}). 
\end{description}
\item[\elem{zeroPointFlux}] Photometric zero point associated to this instance. This element MUST have the following attributes:
\begin{description}
    \item[\attrval{name}{zeroPointFlux}]
    \item[\attrval{ucd}{phot.mag;arith.zp}]
    \item[\attrval{utype}{photDM:PhotCal.zeroPoint.flux.value}]
    \item[\attrval{datatype}{datatype}]
    \item[\attrval{unit}{unit}]
    \item[\attrval{value}{value}]
\end{description}
\item[\elem{magnitudeSystem}] Magnitude system associated to this instance (Vega, AB, ...). This element MUST have the following attributes:
\begin{description}
    \item[\attrval{name}{magnitudeSystem}]
    \item[\attrval{ucd}{meta.code}] 
    \item[\attrval{utype}{photDM:PhotCal.magnitudeSystem.type}]
    \item[\attrval{datatype}{char}]
    \item[\attrval{unit}{unit}]
    \item[\attrval{value}{value}]
\end{description}
\item[\elem{effectiveWavelength}] Effective wavelength of the filter in this instance. This element MUST have the following attributes:
\begin{description}
    \item[\attrval{name}{effectiveWavelength}]
    \item[\attrval{ucd}{em.wl.effective}]
    \item[\attrval{utype}{photDM:PhotometryFilter.spectralLocation.value}] 
    \item[\attrval{datatype}{float}]
    \item[\attrval{unit}{unit}]
    \item[\attrval{value}{value}]
\end{description}
%     \item[\elem{meanRefMag}] Mean value of the magnitude (or flux) of the reference used for calculating diffential photometry in the specified photometric system. This attribute is optional. \todo{Added this to be able to compare differential magnitudes, but this needs discussion. OK, after giving it a thought, although that would be great it's not going to be possible, it would be making data providers give the o-c which they are not giving. Do I drop it but for now I leave the commented text.} 
\end{description}

%\input{filtersys_FILTERSYS.tex}
%Same as above using \elem{GROUP} and \elem{PARAM}s instead. While the above instance is more compact, and perhaps easier to interpret at the client side, the second allows for some flexibility on the data provider side.
 
Proposed annotation example for a \elem{FILTERSYS} element:
\input{filtersys_PARAM.tex}

While following the same approach as for \elem{COOSYS} and \elem{TIMESYS} would result in a more compact annotation, we decide to define this element as a \elem{GROUP} to allow for some flexibility on the data provider side. We are aware that this implies clients to work around more complex annotations. We hope to alleviate that by following the exact \attr{name} convention here proposed. 

%\input{VELSYS}

For other type of data not explecitely defined in this we reccomend to use the appropriate UCD1+ in agreement with \url{http://www.ivoa.net/documents/UCD1+/index.html}. 

%\input{GROUP.tex}
\subsection{\elem{TABLE}}
\elem{TABLE} contains the time series data itself. A service providing time series \textbf{MUST} provide this element and identify it with:
The \elem{TABLE} is identified with:
\begin{description}
\item[\attrval{ucd}{timeseries}]
\item[\attrval{utype}{timeseries}]
\end{description}

The \elem{GROUP} contains:
\begin{description}
     \item[\elem{name}] The name of the group. This attribute is mandatory and it should be set to \verb|timeseries|. 
     \item[\elem{DESCRIPTION}] Human readable text describing the time series. This element is mandatory. 
     \item[\elem{FIELDref}] One or several \elem{FIELDref} (or \elem{PARAMref}) to reference to the \elem{TIMESYS} element. At least one such reference MUST be provided.
     \item[\elem{FIELDref}] One or several \elem{FIELDref} (or \elem{PARAMref}) to reference to the \elem{COOSYS}, \elem{FILTERSYS} as applicable. 
     \item One or several PARAM or PARAMref. This will describe the BAND for instance. While PARAM is usually defining valid for a whole table in this case it will be valid only for the GROUP.  
     \item[\elem{SELECT}] One SELECT attribute. This element provides a way to reference rows instead of columns. This attribute is particular important for cases in which the magnitudes given in a column are not corresponding to the same band and the name of the band is given in a different column. \todo{I hope this is clear, case of ZTF for instance.}
\end{description}

Let us consider the simplest time series case possible: a table containing only three columns \emph{time, magnitude and magnitude error}, the minimum GROUP would be:

\begingroup
\input{vot-ex1.tex}
\endgroup

In this example we have assumened some metadata for \elem{TIMESYS} and \elem{FILTERSYS} and have included to show a full example case. While for the time and the magnitude reference implies an earlier definition of the elements \elem{TIMESYS} and \elem{FILTERSYS} this is not the case for the error. The error in the magnitude references the name of the column which will be repeated in the \elem{FIELD} element directly of the \elem{TABLE}.

We could argue that the \elem{GROUP} is not needed in this case, but the idea is to have a common way to representing time series, including the more complicated cases. 

\newpage 
Let us consider now consider a more complicated case, in which the time series also includes a column to state the name of the filter for wich the magnitudes are given, i.~e. a table containing four columns \emph{time, magnitude and magnitude error, filter name}. In those cases this complicates the annotation and the need of being able to reference rows (as well as columns) becomes clear.

\begingroup
\input{vot-ex2.tex}
\endgroup

To avoid referencing columns, which would make things a bit more complicated, we propose to create different \elem{TABLE} elements, one for each filter. This, although reduntant in the definition of some of the columns, will ease combining timeseries from the client side. 

%Alternative 2: Use the GROUP name=key thing and a different table to define the relation between elements. This 
%Alternative 3: Another possible solution would be to create a new XMLDATA serialization which would allow to tag rows, as proposed in Appendix A.8 of \cite{VOTable1.4}. But wouldn't that break the interoperability? 



The data provider is responsible for providing accurate metadata for the elements here described.
\todo{Do we have to say something about claiming a new capability in the registry? I would say so.}

\section{Serialization examples}
\subsection{Lightcurve distributed by ZTF}

The following serialization is an example of a response of the ZTF time series service and how it could be enhanced, making use of the Time Series model through utypes:
% \footnote{\url{\verb|https://irsa.ipac.caltech.edu/docs/program_interface/ztf_lightcurve_api.html|}}
% in particular this was the query \url{\verb|https://irsa.ipac.caltech.edu/cgi-bin/ZTF/nph_light_curves?POS=CIRCLE%20298.0025%2029.87147%200.0014&BANDNAME=g,r,i|}}
\begin{verbatim}
<?xml version="1.0" encoding="utf-8"?>
<VOTABLE version="1.4" xmlns="http://www.ivoa.net/xml/VOTable/v1.4" 
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <RESOURCE>
   <TIMESYS ID="time" refposition="BARYCENTER" timeorigin="" timescale="TCB"/>
   <TIMESYS ID="htime" refposition="HELIOCENTER" timeorigin="" timescale="TCB"/>
   <COOSYS ID="ICRS" system="ICRS"  epoch="J2015"/>
   <FILTERSYS ID="ztf_g" uniqueIdentifier="Palomar/ZTF.g/Vega" 
           zeroPointFlux="3964.0" magnitudeSystem="Vega" 
           effectiveWavelength="4722.7" />
   <FILTERSYS ID="ztf_r" uniqueIdentifier="Palomar/ZTF.r/Vega" 
           zeroPointFlux="3042.0" magnitudeSystem="Vega" 
           effectiveWavelength="6339.6" />
   <FILTERSYS ID="ztf_i" uniqueIdentifier="Palomar/ZTF.i/Vega" 
           zeroPointFlux="2426.1" magnitudeSystem="Vega" 
           effectiveWavelength="7886.1" />

<GROUP utype="timeseries" >
   <FIELDref
</GROUP>
   <TABLE>
      <FIELD ID="oid" name="oid" datatype="long" ucd="meta.id" utype="Source.identifier" >...</FIELD>
      <FIELD name="hjd" datatype="double" ucd="time.epoch" unit="d">...</FIELD>
      <FIELD name="mjd" datatype="double" ucd="time.epoch;obs.exposure" unit="d">...</FIELD>
      ...
      <DATA>
        <TABLEDATA>
          ...
          ...
          ...
        </TABLEDATA>
      </DATA>
    </TABLE>
  </RESOURCE>
</VOTABLE>
\end{verbatim}

%\section{Architecture}
%We consider the general case of a service returning time series in the form of tabular data.


\section{The Time Series Data Model Summary}
The different components of the Time Series model are summarized in Table~\ref{table:tsmodel}. Each of these components is an independent part and metadata associated to each specific case case should be included in the VOTable when applicable. 
\begin{landscape}
\begin{table}
\begin{center}
\begin{tabular}{|p{0.5\textheight}|p{0.2\textheight}|p{0.4\textheight}|p{0.2\textheight}|p{0.1\textheight}|p{0.15\textheight}|}
%\sptablerule
\hline
\celcol{Utype }  & \celcol{UCD1+} & \celcol{Meaning} & \celcol{Default value} & \celcol{Data type} & \celcol{Required}\\
\sptablerule
\multicolumn{6}{c}{\celcol{Time axis (TIMESYS)}}\\
ts:TimeSys.timescale   &                & Time scale                                               & & string & must \\
\hline
ts:TimeSys.refposition &                & Time reference position                                  & & string & must \\
\hline
ts:TimeSys.origin      &                & Time origin of the time series given as a Julian Date    & & double & must \\
\hline
\multicolumn{6}{c}{\celcol{Case 1: photometric axis (FILTERSYS)}} \\
\hline
ts:PhotCal.identifier  & meta.ref.ivorn & Unique identifier of the Photometry Calibration instance & & string & should \\
\hline
ts:PhotCal.zeroPoint.flux.value & phot.flux.density & flux value at Zero point associated to this filter & & double & should \\ 
\hline 
ts:PhotCal.magnitudeSystem.type & meta.code & Type of magnitude system & VEGAMag & string & should \\
\hline 
ts:MeanRefMag                   &  & Mean magnitude used for differential magnitude calculation in this filter &  & double & should \\
\hline
\multicolumn{6}{c}{\celcol{Case 2: position (COOSYS) }} \\
\multicolumn{6}{c}{\celcol{Case 3: radial velocity axis }} \\
\label{table:tsmodel}
\end{tabular}
\caption{Model components and associated UTYPES, UCD1+ of the Time Series Annotation}
\end{center}
\end{table}
\end{landscape}


\bibliography{ivoatex/ivoabib,ivoatex/docrepo,TimeSeries}


\end{document}
